# 实现计划

- [x] 1. 创建批量选择状态管理
  - 创建 `BatchSelectionState` 数据类，包含选择状态和操作方法
  - 实现 `toggleSelection`、`selectAll`、`clearSelection`、`exitMode` 方法
  - _需求: 2.2, 2.5, 1.4_

- [ ]* 1.1 为 BatchSelectionState 编写属性测试
  - **属性 1: 选择状态切换一致性**
  - **验证: 需求 2.2**

- [ ]* 1.2 为 BatchSelectionState 编写属性测试
  - **属性 2: 全选完整性**
  - **验证: 需求 2.5**

- [x] 2. 扩展 CategoryManager 支持批量操作
  - 在 `CategoryManager` 中添加 `setAudioCategoryBatch` 方法
  - 实现事务性批量设置分类逻辑
  - 添加错误处理和回滚机制
  - _需求: 4.2_

- [ ]* 2.1 为批量分类操作编写属性测试
  - **属性 5: 批量分类完整性**
  - **验证: 需求 4.2**

- [x] 3. 创建底部操作面板组件
  - 创建 `BatchSelectionBottomPanel` Composable
  - 实现关闭按钮、选中计数显示
  - 实现分类列表（横向滚动布局）
  - 添加进入/退出动画（AnimatedVisibility）
  - _需求: 3.3, 4.1_

- [ ]* 3.1 为底部面板编写属性测试
  - **属性 9: 分类列表过滤**
  - **验证: 需求 4.1**

- [x] 4. 修改音频卡片支持批量选择
  - 在音频卡片左侧添加 Checkbox 组件
  - 根据 `isBatchMode` 控制复选框显示/隐藏
  - 在批量模式下修改点击行为（选择而非播放）
  - 添加选中状态的视觉高亮效果
  - 在批量模式下禁用长按菜单
  - _需求: 2.1, 2.2, 6.1, 6.3, 6.4_

- [ ]* 4.1 为音频卡片批量模式编写属性测试
  - **属性 8: 模式激活时的UI状态**
  - **验证: 需求 2.1, 6.3**

- [x] 5. 在 AudiobookScreenImpl 中集成批量选择状态
  - 添加 `batchSelectionState` 状态变量
  - 在顶部工具栏添加全选/取消按钮
  - 根据批量模式切换按钮图标
  - 实现全选按钮点击逻辑
  - _需求: 1.1, 1.2, 1.3, 1.4_

- [ ]* 5.1 为模式切换编写属性测试
  - **属性 6: 模式退出清理**
  - **验证: 需求 1.4, 3.4, 5.4**

- [x] 6. 实现音频卡片选择交互
  - 将批量选择状态传递给音频卡片
  - 实现卡片点击时的选择切换逻辑
  - 更新选中计数显示
  - _需求: 2.2, 2.3, 2.4_

- [ ]* 6.1 为选中计数编写属性测试
  - **属性 4: 选中计数准确性**
  - **验证: 需求 2.3, 2.4, 6.2**

- [x] 7. 实现底部面板显示逻辑
  - 根据选中集合是否为空控制面板显示
  - 将选中数量传递给面板组件
  - 将分类列表（过滤"全部"）传递给面板
  - _需求: 3.1, 3.2, 3.3_

- [ ]* 7.1 为面板显示条件编写属性测试
  - **属性 3: 面板显示条件**
  - **验证: 需求 3.1, 3.2**

- [x] 8. 实现批量分类操作
  - 实现面板中分类点击回调
  - 调用 `CategoryManager.setAudioCategoryBatch` 执行批量操作
  - 显示成功/失败 Snackbar 提示
  - 操作完成后退出批量选择模式并刷新列表
  - _需求: 4.2, 4.3, 4.4_

- [x] 9. 实现分类切换时的状态清理
  - 监听分类标签切换事件
  - 在切换时清空选中集合
  - 保持批量选择模式激活状态
  - _需求: 5.3_

- [ ]* 9.1 为分类切换清理编写属性测试
  - **属性 7: 分类切换清理**
  - **验证: 需求 5.3**

- [x] 10. 实现返回键处理
  - 添加 BackHandler 处理批量选择模式
  - 按返回键时退出批量选择模式
  - 确保优先级高于其他返回键处理
  - _需求: 5.4_

- [x] 11. 处理与现有功能的冲突
  - 在批量选择模式下禁用排序模式按钮
  - 在进入搜索模式时退出批量选择模式
  - 在进入排序模式时退出批量选择模式
  - 确保滚动和导航功能正常工作
  - _需求: 5.1, 5.2_

- [x] 12. 优化性能和动画
  - 使用 `remember` 和 `derivedStateOf` 优化重组
  - 为底部面板添加平滑的进入/退出动画
  - 为复选框添加淡入/淡出动画
  - 为选中状态添加背景色过渡动画
  - _需求: 6.1_

- [ ]* 13. 编写集成测试
  - 测试完整的批量选择和分类流程
  - 测试分类切换时的状态清理
  - 测试返回键处理
  - 测试与现有功能的集成

- [x] 14. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户
